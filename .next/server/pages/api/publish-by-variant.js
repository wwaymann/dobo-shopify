"use strict";(()=>{var a={};a.id=370,a.ids=[370],a.modules={3366:(a,b,c)=>{c.r(b),c.d(b,{config:()=>A,default:()=>z,handler:()=>C});var d={};c.r(d),c.d(d,{config:()=>j,default:()=>w,runtime:()=>i});var e=c(9046),f=c(8667),g=c(3480),h=c(6435);let i="nodejs",j={api:{bodyParser:{sizeLimit:"25mb"}}},k=process.env.SHOPIFY_ADMIN_API_VERSION||"2024-10";function l(){let a=process.env.SHOPIFY_ADMIN_TOKEN||process.env.SHOPIFY_ADMIN_API_TOKEN,b=process.env.SHOPIFY_SHOP_DOMAIN||process.env.SHOPIFY_SHOP||process.env.SHOP_DOMAIN||"";return{token:a,url:process.env.SHOPIFY_ADMIN_API_URL||(b?`https://${b}/admin/api/${k}/graphql.json`:""),shop:b}}async function m(a,b){let{token:c,url:d}=l();if(!c||!d){let a=Error("env-missing");throw a.stage="env",a}let e=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json","X-Shopify-Access-Token":c},body:JSON.stringify({query:a,variables:b})}),f=await e.text(),g=null;try{g=JSON.parse(f)}catch{}if(!e.ok||!g||g.errors){let a=Error("shopify-graphql-error");throw a.stage="graphql",a.details={status:e.status,body:f},a}return g.data}let n=`
mutation stagedUploadsCreate($input: [StagedUploadInput!]!) {
  stagedUploadsCreate(input: $input) {
    stagedTargets { url resourceUrl parameters { name value } }
    userErrors { field message }
  }
}`,o=`
mutation fileCreate($files: [FileCreateInput!]!) {
  fileCreate(files: $files) {
    files {
      id __typename createdAt
      ... on MediaImage { image { url } }
      ... on GenericFile { url }
    }
    userErrors { field message }
  }
}`,p=`
query filesById($ids: [ID!]!) {
  nodes(ids: $ids) {
    id __typename
    ... on MediaImage { image { url } }
    ... on GenericFile { url }
  }
}`,q=`
query($id: ID!) {
  productVariant(id: $id) { id product { id handle } }
}`,r=`
mutation metafieldsSet($metafields: [MetafieldsSetInput!]!) {
  metafieldsSet(metafields: $metafields) {
    metafields { id key namespace }
    userErrors { field message }
  }
}`;async function s({filename:a,mimeType:b,buffer:c,resource:d}){let e=await m(n,{input:[{resource:d,filename:a,mimeType:b,httpMethod:"POST"}]}),f=e?.stagedUploadsCreate?.stagedTargets?.[0],g=e?.stagedUploadsCreate?.userErrors||[];if(!f||g.length){let a=Error("staged-uploads-failed");throw a.stage="stagedUploadsCreate",a.details=g,a}let h=new FormData;for(let a of f.parameters||[])h.append(a.name,a.value);h.append("file",new Blob([c]),a);let i=await fetch(f.url,{method:"POST",body:h});if(!i.ok){let a=await i.text().catch(()=>""),b=Error("gcs-upload-failed");throw b.stage="gcs-upload",b.details={status:i.status,body:a},b}return f.resourceUrl}async function t(a){let b=a.map(a=>({originalSource:a.resourceUrl,contentType:a.contentType,alt:a.alt||null})),c=await m(o,{files:b}),d=c?.fileCreate?.userErrors||[];if(d.length){let a=Error("fileCreate-errors");throw a.stage="fileCreate",a.details=d,a}let e=c?.fileCreate?.files||[],f=e.map(a=>a.id).filter(Boolean),g=e.map(a=>"MediaImage"===a.__typename?a.image?.url||"":"GenericFile"===a.__typename&&a.url||""),h=()=>g.every(a=>"string"==typeof a&&a.length>0);for(let a=0;a<8&&!h();a++){await new Promise(b=>setTimeout(b,400+150*a));let b=await m(p,{ids:f}),c=new Map((b?.nodes||[]).map(a=>{let b=a?.__typename==="MediaImage"?a?.image?.url||"":a?.__typename==="GenericFile"&&a?.url||"";return[a?.id,b]}));g=e.map(a=>c.get(a.id)||"")}if(!h()){let a=Error("missing file urls");throw a.stage="fileCreate",a.details={ids:f,urls:g},a}return{files:e,urls:g}}async function u(a){let b=await m(q,{id:((a,b)=>{let c=String(b||"");return c.startsWith("gid://")?c:`gid://shopify/${a}/${c}`})("ProductVariant",a)}),c=b?.productVariant;if(!c?.product?.id){let b=Error("variant-parent-not-found");throw b.stage="variantLookup",b.details={variantId:a},b}return{productId:c.product.id,handle:c.product.handle||""}}async function v(a,b,c){let d=[];if(b&&d.push({ownerId:a,namespace:"dobo",key:"design_preview",type:"url",value:b}),c&&d.push({ownerId:a,namespace:"dobo",key:"design_json_url",type:"url",value:c}),!d.length)return;let e=await m(r,{metafields:d}),f=e?.metafieldsSet?.userErrors||[];if(f.length){let a=Error("metafieldsSet-errors");throw a.stage="metafieldsSet",a.details=f,a}}async function w(a,b){try{if("POST"!==a.method)return b.status(405).json({ok:!1,error:"method-not-allowed"});let{token:c,url:d}=l();if(!c||!d)return b.status(400).json({ok:!1,error:"env-missing"});let{variantId:e,previewDataURL:f,design:g,meta:h={}}=a.body||{};if(!e)return b.status(400).json({ok:!1,error:"missing-variantId"});let i=function(a){if(!a||"string"!=typeof a)return null;let b=a.match(/^data:([\w/+.-]+);base64,(.*)$/);return b?{mime:b[1],buf:Buffer.from(b[2],"base64")}:null}(f);if(!i?.buf||!/image\/png/i.test(i.mime||"")){let a=Error("invalid-preview");throw a.stage="decodePreview",a}let j="string"==typeof g?JSON.parse(g):g||{},k={...j,meta:{...j.meta||{},...h}},m=Buffer.from(JSON.stringify(k),"utf8"),n=Date.now(),o=`dobo-${n}.png`,p=`dobo-${n}.json`,[q,r]=await Promise.all([s({filename:o,mimeType:"image/png",buffer:i.buf,resource:"IMAGE"}),s({filename:p,mimeType:"application/json",buffer:m,resource:"FILE"})]),w=await t([{resourceUrl:q,contentType:"IMAGE",alt:`preview-${n}`},{resourceUrl:r,contentType:"FILE",alt:`design-${n}`}]),[x,y]=w.urls;if(!x||!y){let a=Error("missing file urls");throw a.stage="fileCreate",a.details=w,a}let{productId:z,handle:A}=await u(e);await v(z,x,y),b.status(200).json({ok:!0,variantId:e,productId:z,handle:A,previewUrl:x,jsonUrl:y})}catch(c){let a=c?.stage==="env"?400:500;b.status(a).json({ok:!1,error:String(c?.message||c||"error"),stage:c?.stage||null,details:c?.details||null})}}var x=c(8112),y=c(8766);let z=(0,h.M)(d,"default"),A=(0,h.M)(d,"config"),B=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/publish-by-variant",pathname:"/api/publish-by-variant",bundlePath:"",filename:""},userland:d,distDir:".next",projectDir:""});async function C(a,b,c){let d=await B.prepare(a,b,{srcPage:"/api/publish-by-variant"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h}=d;try{let c=a.method||"GET",d=(0,x.getTracer)(),e=d.getActiveScopeSpan(),i=B.instrumentationOnRequestError.bind(B),j=async e=>B.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:void 0,multiZoneDraftMode:!0,trustHostHeader:void 0,previewProps:h.preview,propagateError:!1,dev:B.isDev,page:"/api/publish-by-variant",projectDir:"",onError:(...b)=>i(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==y.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await j(e):await d.withPropagatedContext(a.headers,()=>d.trace(y.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:x.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},j))}catch(a){if(B.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")}};var b=require("../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[169],()=>b(b.s=3366));module.exports=c})();