"use strict";(()=>{var a={};a.id=527,a.ids=[527],a.modules={3719:(a,b,c)=>{c.r(b),c.d(b,{config:()=>n,default:()=>m,handler:()=>p});var d={};c.r(d),c.d(d,{default:()=>i});var e=c(9046),f=c(8667),g=c(3480),h=c(6435);async function i(a,b){if("POST"!==a.method)return b.setHeader("Allow","POST"),b.status(405).json({ok:!1,error:"method-not-allowed"});let c=process.env.SHOPIFY_SHOP||process.env.NEXT_PUBLIC_SHOP_DOMAIN,d=process.env.SHOPIFY_ADMIN_TOKEN,e=process.env.SHOPIFY_PUBLICATION_ID;if(!c||!d)return b.status(500).json({ok:!1,error:"missing-env",details:{need:["SHOPIFY_SHOP","SHOPIFY_ADMIN_TOKEN"],have:{SHOP:!!c,ADMIN_TOKEN:!!d}}});try{let f,{title:g="DOBO",price:h=0,previewUrl:i="",color:k="",size:l="",designId:m=`dobo-${Date.now()}`,plantTitle:n="",potTitle:o="",shortDescription:p="",attrs:q=[]}=a.body&&"object"==typeof a.body?a.body:{},r={title:String(g||`DOBO ${n} + ${o}`).slice(0,250),status:"active",vendor:"DOBO",product_type:"DOBO",body_html:p?.trim()?j(p.trim()):j(["DOBO personalizado",n&&`Planta: ${n}`,o&&`Maceta: ${o}`,l&&`Tama\xf1o: ${l}`,k&&`Color: ${k}`].filter(Boolean).join(" \xb7 ")),tags:["DOBO","custom",n&&`plant:${n}`,o&&`pot:${o}`,l&&`size:${l}`,k&&`color:${k}`,m&&`design:${m}`].filter(Boolean).join(", "),images:i?[{src:String(i)}]:[],variants:[{price:String(Number(h||0)),option1:"Default Title",sku:String(m),inventory_management:null,inventory_policy:"deny",taxable:!1}]},s="2024-07",t=await fetch(`https://${c}/admin/api/${s}/products.json`,{method:"POST",headers:{"X-Shopify-Access-Token":d,"Content-Type":"application/json"},body:JSON.stringify({product:r})}),u=await t.text();try{f=JSON.parse(u)}catch{f=null}if(!t.ok||f?.errors)return b.status(t.status||500).json({ok:!1,error:"admin:create-product",details:f?.errors||u||`HTTP ${t.status}`});let v=f?.product,w=v?.variants?.[0],x=v?.admin_graphql_api_id;if(!w?.id||!x)return b.status(500).json({ok:!1,error:"missing-variant-or-gid",details:v});if(e){let a=`
        mutation PublishToOnlineStore($id: ID!, $pubId: ID!) {
          publishablePublish(id: $id, input: { publicationId: $pubId }) {
            userErrors { field message }
          }
        }
      `,b=await fetch(`https://${c}/admin/api/${s}/graphql.json`,{method:"POST",headers:{"X-Shopify-Access-Token":d,"Content-Type":"application/json"},body:JSON.stringify({query:a,variables:{id:x,pubId:e}})}),f=await b.json().catch(()=>({})),g=f?.data?.publishablePublish?.userErrors;(!b.ok||g&&g.length)&&console.warn("publishablePublish error",g||f)}try{let b=`${a.headers["x-forwarded-proto"]||"https"}://${a.headers.host}`,d=(Array.isArray(a.body?.attrs)?a.body.attrs:[]).map(a=>({key:String(a?.key||""),value:String(a?.value??"")})),e={attrs:d.some(a=>{let b=a.key.toLowerCase();return b.includes("designpreview")||b.startsWith("layer:")})?d:i?[{key:"DesignPreview",value:String(i)}]:[],meta:{Descripcion:p||"DOBO",Precio:Number(h||0)},links:v?.handle?{"Producto (storefront)":`https://${c}/products/${v.handle}`}:{},attachPreviews:!0};fetch(`${b}/api/send-design-email`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).catch(()=>{})}catch(a){console.warn("post-create email failed (non-blocking):",a)}return b.status(200).json({ok:!0,productId:v.id,variantId:w.id,handle:v.handle||"",image:v?.image?.src||(v?.images?.[0]?.src??""),adminGraphQLId:x})}catch(a){return b.status(500).json({ok:!1,error:"unhandled",details:a?.message||String(a)})}}function j(a=""){return String(a).replace(/[&<>\"']/g,a=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[a])}var k=c(8112),l=c(8766);let m=(0,h.M)(d,"default"),n=(0,h.M)(d,"config"),o=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/design-product",pathname:"/api/design-product",bundlePath:"",filename:""},userland:d,distDir:".next",projectDir:""});async function p(a,b,c){let d=await o.prepare(a,b,{srcPage:"/api/design-product"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h}=d;try{let c=a.method||"GET",d=(0,k.getTracer)(),e=d.getActiveScopeSpan(),i=o.instrumentationOnRequestError.bind(o),j=async e=>o.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:void 0,multiZoneDraftMode:!0,trustHostHeader:void 0,previewProps:h.preview,propagateError:!1,dev:o.isDev,page:"/api/design-product",projectDir:"",onError:(...b)=>i(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await j(e):await d.withPropagatedContext(a.headers,()=>d.trace(l.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:k.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},j))}catch(a){if(o.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")}};var b=require("../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[169],()=>b(b.s=3719));module.exports=c})();