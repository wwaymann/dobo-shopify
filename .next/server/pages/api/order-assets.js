"use strict";(()=>{var a={};a.id=929,a.ids=[929],a.modules={1420:(a,b,c)=>{c.r(b),c.d(b,{config:()=>z,default:()=>y,handler:()=>B});var d={};c.r(d),c.d(d,{config:()=>m,default:()=>v});var e=c(9046),f=c(8667),g=c(3480),h=c(6435);let i=require("pdfkit");var j=c.n(i),k=c(1572),l=c.n(k);let m={api:{bodyParser:{sizeLimit:"10mb"}}},n=process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME,o=process.env.NEXT_PUBLIC_CLOUDINARY_UNSIGNED_PRESET,p=process.env.MERCHANT_NOTIF_EMAIL,q=process.env.ORDER_FLOW_SECRET,r=process.env.GMAIL_USER,s=process.env.GMAIL_APP_PASSWORD;async function t(a){let b=await fetch(a);if(!b.ok)throw Error(`No se pudo bajar: ${a}`);let c=await b.arrayBuffer();return Buffer.from(c)}async function u(a,b){let c=new FormData;c.append("file",new Blob([a]),`${b}.pdf`),c.append("upload_preset",o);let d=await fetch(`https://api.cloudinary.com/v1_1/${n}/raw/upload`,{method:"POST",body:c}),e=await d.json();if(!d.ok)throw Error(e?.error?.message||"Error Cloudinary RAW");return e.secure_url||e.url}async function v(a,b){try{if("POST"!==a.method)return b.status(405).json({error:"Method not allowed"});if(q){let c=a.headers["x-flow-secret"];if(!c||c!==q)return b.status(401).json({error:"Unauthorized"})}let c="string"==typeof a.body?JSON.parse(a.body):a.body;if(!c||!c.line_items)return b.status(400).json({error:"Order JSON inv\xe1lido"});let d=c.line_items,e=a=>(a.properties||[]).some(a=>"_Accessory"===(a.name||a.key)&&"true"===a.value),f=d.filter(a=>!e(a)),g=f.find(a=>(a.properties||[]).some(a=>"_LinePriority"===(a.name||a.key)&&"0"===a.value))||f[0];if(!g)return b.status(400).json({error:"No se encontr\xf3 l\xednea DOBO"});let h=(a,b)=>{let c=b.toLowerCase(),d=(a.properties||[]).find(a=>{let b=(a.name||a.key||"").toLowerCase();return b===c||b===`_${c}`});return d?d.value:""},i=h(g,"DesignPreview"),k=h(g,"DesignLayer")||h(g,"DesignLayerUrl"),m=h(g,"DesignId"),n=h(g,"DesignColor"),o=h(g,"DesignSize"),v=d.filter(e).map(a=>a.title).filter(Boolean),w=null,x=null;if(i)try{w=await t(i)}catch{}if(k)try{x=await t(k)}catch{}let y={previewUrl:i,layerUrl:k,previewBuf:w,layerBuf:x,plantTitle:g?.product_title?.includes("+")?g.product_title.split("+")[0].trim():"",potTitle:g?.product_title?.includes("+")?g.product_title.split("+")[1]?.trim():"",color:n,size:o,designId:m},z=await function({orderName:a,dobo:b,accessories:c}){return new Promise((d,e)=>{let f=new(j())({size:"A4",margin:36}),g=[];if(f.on("data",a=>g.push(a)),f.on("end",()=>d(Buffer.concat(g))),f.on("error",e),f.fontSize(18).text("Resumen de dise\xf1o DOBO"),a&&f.moveDown(.25).fontSize(12).fillColor("#666").text(`Pedido: ${a}`).fillColor("#000"),f.moveDown(),b.previewBuf){f.text("Vista previa combinada:",{underline:!0}),f.moveDown(.25);try{f.image(b.previewBuf,{fit:[520,320]})}catch{}f.moveDown()}if(b.layerBuf){f.text("Capa de dise\xf1o (PNG transparente):",{underline:!0}),f.moveDown(.25);try{f.image(b.layerBuf,{fit:[380,280]})}catch{}f.moveDown()}f.text("Especificaciones:",{underline:!0});let h=[["Planta",b.plantTitle||"-"],["Maceta",b.potTitle||"-"],["Color",b.color||"-"],["Tama\xf1o",b.size||"-"],["Design ID",b.designId||"-"]];f.moveDown(.25),h.forEach(([a,b])=>f.fontSize(11).text(`${a}: ${b}`)),f.moveDown(),c?.length&&(f.text("Accesorios:",{underline:!0}),c.forEach(a=>f.fontSize(11).text(`â€¢ ${a}`)),f.moveDown()),(b.previewUrl||b.layerUrl)&&(f.text("Enlaces t\xe9cnicos:",{underline:!0}),b.previewUrl&&f.fontSize(10).fillColor("#0a61ff").text(b.previewUrl),b.layerUrl&&f.fontSize(10).fillColor("#0a61ff").text(b.layerUrl),f.fillColor("#000")),f.end()})}({orderName:c.name||c.order_number||"",dobo:y,accessories:v}),A="";try{A=await u(z,`dobo-order-${Date.now()}`)}catch{}if(!r||!s||!p)return b.status(200).json({ok:!0,warn:"Faltan GMAIL_USER/GMAIL_APP_PASSWORD/MERCHANT_NOTIF_EMAIL",pdfUrl:A});let B=l().createTransport({host:"smtp.gmail.com",port:465,secure:!0,auth:{user:r,pass:s}}),C=[];return z&&C.push({filename:"dobo-resumen.pdf",content:z,contentType:"application/pdf"}),y.layerBuf&&C.push({filename:"dobo-design-layer.png",content:y.layerBuf,contentType:"image/png"}),y.previewBuf&&C.push({filename:"dobo-preview.png",content:y.previewBuf,contentType:"image/png"}),await B.sendMail({from:`"DOBO" <${r}>`,to:p,subject:`DOBO - Pedido ${c.name||c.id}`,text:`Se adjuntan resumen PDF y assets. PDF: ${A||"(adjunto)"}`,html:`<p>Se adjuntan resumen PDF y assets.</p>${A?`<p>PDF: <a href="${A}">${A}</a></p>`:""}`,attachments:C}),b.status(200).json({ok:!0,pdfUrl:A})}catch(a){return console.error(a),b.status(500).json({error:a.message})}}var w=c(8112),x=c(8766);let y=(0,h.M)(d,"default"),z=(0,h.M)(d,"config"),A=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/order-assets",pathname:"/api/order-assets",bundlePath:"",filename:""},userland:d,distDir:".next",projectDir:""});async function B(a,b,c){let d=await A.prepare(a,b,{srcPage:"/api/order-assets"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h}=d;try{let c=a.method||"GET",d=(0,w.getTracer)(),e=d.getActiveScopeSpan(),i=A.instrumentationOnRequestError.bind(A),j=async e=>A.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:void 0,multiZoneDraftMode:!0,trustHostHeader:void 0,previewProps:h.preview,propagateError:!1,dev:A.isDev,page:"/api/order-assets",projectDir:"",onError:(...b)=>i(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==x.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await j(e):await d.withPropagatedContext(a.headers,()=>d.trace(x.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:w.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},j))}catch(a){if(A.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}},1572:a=>{a.exports=require("nodemailer")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")}};var b=require("../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[169],()=>b(b.s=1420));module.exports=c})();